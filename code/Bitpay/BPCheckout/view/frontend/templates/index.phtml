<?php
$config = $block->getLayout()->createBlock(\Magento\Config\Block\System\Config\Form::class);
$configValue = $config->getConfigValue('web/secure/base_url');
$env = $config->getConfigValue('payment/bpcheckout/bitpay_endpoint');
extract($_GET);
?>
<script src = "//bitpay.com/bitpay.min.js" type = "text/javascript"></script>
<script type = "text/javascript">
       
        var $invoiceID = getParams()['invoiceID']
        var $order_id = getParams()['order_id']
         $env = '<?php echo $env;?>'
        if($env == "test"){
            bitpay.enableTestMode()
        }

    var is_paid = false
    window.addEventListener("message", function (event) {
        payment_status = event.data.status;
        if (payment_status == "paid") {
            is_paid = true
            //clear the cookies
            $guest = getParams()['g']
          
            deleteCookie('env')
            deleteCookie('invoicedata')
            deleteCookie('modal')

            if($guest ==1){
                window.location.replace(window.location.origin+'/sales/guest/form')
            }else{
                window.location.replace(window.location.origin+'/sales/order/view/order_id/'+$order_id)
            }
            return;
        }
    }, false);

    //show the order info
    bitpay.onModalWillLeave(function () {
        if (!is_paid) {
            jQuery("#bitpay-header").text('Redirecting to cart...')
            //clear the cookies and redirect back to the cart
            deleteCookie('env')
            deleteCookie('invoicedata')
            deleteCookie('modal')
           
            window.location.replace(window.location.origin+"/rest/V1/bitpay-bpcheckout/close?orderID="+$order_id);

        } //endif

    });


        setTimeout(function(){ 
            bitpay.showInvoice($invoiceID)
            }, 
            500);

            function getParams() {
                var vars = {};
                var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
                    vars[key] = value;
                });
                return vars;
            }
            function getCookie(cname) {
            var name = cname + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }
            function deleteCookie(cname) {
                document.cookie = cname + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/;';
            }
        </script>

<h2 id = "bitpay-header">Loading BitPay Invoice...</h2>
